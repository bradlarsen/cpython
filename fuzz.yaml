base: ubuntu:16.04

setup: # global setup steps here
- DEBIAN_FRONTEND=noninterative sudo apt-get -y update
- DEBIAN_FRONTEND=noninteractive sudo apt-get -y install build-essential
- export ASAN_OPTIONS=detect_leaks=0 LSAN_OPTIONS=verbosity=1:log_threads=1 CC="$FUZZ_CC" CXX="$FUZZ_CXX" CFLAGS="$CFLAGS -O2" CXXFLAGS="$CXXFLAGS -O2" && ./configure --with-address-sanitizer --with-assertions --with-pydebug && make -j4
- sudo make install

environment: # global env vars here
- LSAN_OPTIONS=verbosity=1:log_threads=1

targets:

- name: marshal-loads
  language: c
  setup:
  - $FUZZ_CC $CFLAGS fuzz/tests/marshal-loads/src/target.c -c -o fuzz/tests/marshal-loads/target.o
  - $FUZZ_CXX $CXXFLAGS fuzz/tests/marshal-loads/target.o $FUZZ_ENGINE -o fuzz/tests/marshal-loads/target
  corpus: fuzz/tests/marshal-loads/corpus
  harness:
    binary: fuzz/tests/marshal-loads/target
  sanitizers:
    address: detect_stack_use_after_return=1
